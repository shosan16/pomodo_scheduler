<%= stylesheet_link_tag "timer" %>
<input type="button" value="Start" id="start" onclick="startTasks()">
残り<p id="remaining_set_number"></span>セット
<p id="tasi_name"></p>
<div class="timer">
  <div class="container">
    <div class="row">
      <div id="hour" class="col-md-2 num">00</div>
      <div class="col-md-3 unit">:</div>
      <div id="minute" class="col-md-2 num">00</div>
      <div class="col-md-3 unit">:</div>
      <div id="second" class="col-md-2 num">00</div>
    </div>
  </div>
</div>

<script>
  const taskName         = document.getElementById("taskName");
  var remainingSetNumber = document.getElementById("remaining_set_number");
  const hours            = document.getElementById("hour");                   //時を表示するエリアの変数
  const minutes          = document.getElementById("minute");                 //分を表示するエリアの変数
  const seconds          = document.getElementById("second");                 //秒を表示するエリアの変数

  var setNumber;
  var taskTime;
  var restTime;

  var startTime;
  var finishTime;   //タスクのカウントダウンを始める度に再代入

  const _sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));   //並行処理をさせないためのおまじない

  async function startTasks() {
    setNumber = Number(document.getElementById("set_number").value);
    
    while(setNumber > 0) {        //セット数分繰り返す
      taskTime = Number(document.getElementById("task_time").value);
      restTime = Number(document.getElementById("rest_time").value);

      await countDown(taskTime);  //タスク時間のカウントダウン
      await countDown(restTime);  //休憩時間のカウントダウン
      setNumber--;
    }
  }

  function countDown(time) {
    setTimer(time);
    var tid = setInterval(function(){       //10ミリ秒の間隔でdisplayメソッドを繰り返す
                              display();
                            }, 10);
    return _sleep(time*60*1000);
  }

  function setTimer(time) {
    startTime = new Date();
    finishTime = startTime.setMinutes(startTime.getMinutes() + time);
  }

  function display() {
    const now = new Date();
    let diff_sec = Math.floor((finishTime - now)/1000);
    minus_check(diff_sec);
    
    hour = Math.floor(diff_sec / 3600);
    diff_sec -= hour * 3600;
    hours.innerHTML = format(hour);

    minute = Math.floor(diff_sec / 60);
    diff_sec -= minute * 60;
    minutes.innerHTML = format(minute);

    second = Math.floor(diff_sec);
    seconds.innerHTML = format(second);
  }

  function minus_check(num) {
    if (num <= 0) {
      clearInterval(tid);
    }
  }

  function format(num) {
    let display_num;
    
    if (num < 10) {
      display_num = "0"+num;
    } else {
      display_num = num;
    }
    return display_num;
  }
</script>